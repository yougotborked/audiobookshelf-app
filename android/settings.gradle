plugins {
  id("org.gradle.toolchains.foojay-resolver-convention") version "0.9.0"
}

def embeddedJdks = [
  file("$rootDir/.jdk/jdk-21.0.4+7"),
  file("$rootDir/.jdk/jdk-17.0.13+11")
].findAll { it.exists() }

if (!embeddedJdks.isEmpty()) {
  // Prefer the embedded JDKs when present so builds work without a system-wide install
  def configuredPaths = embeddedJdks.collect { it.absolutePath }.join(File.pathSeparator)
  if (!System.getProperty('org.gradle.java.installations.paths')) {
    System.setProperty('org.gradle.java.installations.paths', configuredPaths)
  }

  if (!System.getProperty('org.gradle.java.home')) {
    def preferredJdk = embeddedJdks.find { it.name.startsWith('jdk-21') } ?: embeddedJdks.first()
    System.setProperty('org.gradle.java.home', preferredJdk.absolutePath)
  }
}

include ':app'

def agpVersion = providers.gradleProperty('agpVersion').getOrElse('8.13.1')

def rewriteAgpCoordinate = { File gradleFile ->
  if (!gradleFile?.exists()) return

  def desiredAgpLine = "com.android.tools.build:gradle:${agpVersion}"
  def originalScript = gradleFile.getText('UTF-8')
  def updatedScript = originalScript.replaceAll(/com\.android\.tools\.build:gradle:[0-9.]+/, desiredAgpLine)

  if (updatedScript != originalScript) {
    gradleFile.setText(updatedScript, 'UTF-8')
  }
}

def cordovaAndroidPluginsDir = file('./capacitor-cordova-android-plugins/')
if (cordovaAndroidPluginsDir.exists()) {
  rewriteAgpCoordinate(new File(cordovaAndroidPluginsDir, 'build.gradle'))

  include ':capacitor-cordova-android-plugins'
  project(':capacitor-cordova-android-plugins').projectDir = cordovaAndroidPluginsDir
}

// Align AGP across included Capacitor community modules that ship their own buildscript classpath
def repoRoot = rootDir.parentFile
fileTree(dir: repoRoot, include: ['node_modules/**/android/build.gradle']).each { gradleFile ->
  rewriteAgpCoordinate(gradleFile)
}

apply from: 'capacitor.settings.gradle'
